// Copyright 2010 William Malone (www.williammalone.com)
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
var canvas,context,canvasWidth=490,canvasHeight=220,padding=25,lineWidth=8,colorPurple="#cb3594",colorGreen="#659b41",colorYellow="#ffcf33",colorBrown="#986928",outlineImage=new Image,crayonImage=new Image,markerImage=new Image,eraserImage=new Image,crayonBackgroundImage=new Image,markerBackgroundImage=new Image,eraserBackgroundImage=new Image,crayonTextureImage=new Image,clickX=new Array,clickY=new Array,clickColor=new Array,clickTool=new Array,clickSize=new Array,clickDrag=new Array,paint=!1,curColor=colorPurple,curTool="crayon",curSize="normal",mediumStartX=18,mediumStartY=19,mediumImageWidth=93,mediumImageHeight=46,drawingAreaX=111,drawingAreaY=11,drawingAreaWidth=267,drawingAreaHeight=200,toolHotspotStartY=23,toolHotspotHeight=38,sizeHotspotStartY=157,sizeHotspotHeight=36,sizeHotspotWidthObject=new Object;sizeHotspotWidthObject.huge=39,sizeHotspotWidthObject.large=25,sizeHotspotWidthObject.normal=18,sizeHotspotWidthObject.small=16;var totalLoadResources=8,curLoadResNum=0;function resourceLoaded(){++curLoadResNum>=totalLoadResources&&redraw()}function prepareCanvas(){var e=document.getElementById("canvasDiv");canvas=document.createElement("canvas"),console.log(canvas),canvas.setAttribute("width",canvasWidth),canvas.setAttribute("height",canvasHeight),canvas.setAttribute("id","canvas"),e.appendChild(canvas),"undefined"!=typeof G_vmlCanvasManager&&(canvas=G_vmlCanvasManager.initElement(canvas)),context=canvas.getContext("2d"),crayonImage.onload=function(){resourceLoaded()},crayonImage.src="<%= asset_path 'crayon-outline.png'%>",markerImage.onload=function(){resourceLoaded()},markerImage.src="<%= asset_path 'marker-outline.png'%>",eraserImage.onload=function(){resourceLoaded()},eraserImage.src="<%= asset_path 'eraser-outline.png'%>",crayonBackgroundImage.onload=function(){resourceLoaded()},crayonBackgroundImage.src="<%= asset_path 'crayon-background.png'%>",markerBackgroundImage.onload=function(){resourceLoaded()},markerBackgroundImage.src="<%= asset_path 'marker-background.png'%>",eraserBackgroundImage.onload=function(){resourceLoaded()},eraserBackgroundImage.src="<%= asset_path 'eraser-background.png'%>",crayonTextureImage.onload=function(){resourceLoaded()},crayonTextureImage.src="<%= asset_path 'crayon-texture.png'%>",outlineImage.onload=function(){resourceLoaded()},outlineImage.src="<%= asset_path 'watermelon-duck-outline.png'%>",$("#canvas").mousedown(function(e){var t=e.pageX-this.offsetLeft,o=e.pageY-this.offsetTop;if(t<drawingAreaX)t>mediumStartX&&(o>mediumStartY&&o<mediumStartY+mediumImageHeight?curColor=colorPurple:o>mediumStartY+mediumImageHeight&&o<mediumStartY+2*mediumImageHeight?curColor=colorGreen:o>mediumStartY+2*mediumImageHeight&&o<mediumStartY+3*mediumImageHeight?curColor=colorYellow:o>mediumStartY+3*mediumImageHeight&&o<mediumStartY+4*mediumImageHeight&&(curColor=colorBrown));else if(t>drawingAreaX+drawingAreaWidth&&o>toolHotspotStartY)if(o>sizeHotspotStartY){var a=drawingAreaX+drawingAreaWidth;o<sizeHotspotStartY+sizeHotspotHeight&&t>a&&(t<a+sizeHotspotWidthObject.huge?curSize="huge":t<a+sizeHotspotWidthObject.large+sizeHotspotWidthObject.huge?curSize="large":t<a+sizeHotspotWidthObject.normal+sizeHotspotWidthObject.large+sizeHotspotWidthObject.huge?curSize="normal":t<a+sizeHotspotWidthObject.small+sizeHotspotWidthObject.normal+sizeHotspotWidthObject.large+sizeHotspotWidthObject.huge&&(curSize="small"))}else o<toolHotspotStartY+toolHotspotHeight?curTool="crayon":o<toolHotspotStartY+2*toolHotspotHeight?curTool="marker":o<toolHotspotStartY+3*toolHotspotHeight&&(curTool="eraser");paint=!0,addClick(t,o,!1),redraw()}),$("#canvas").mousemove(function(e){1==paint&&(addClick(e.pageX-this.offsetLeft,e.pageY-this.offsetTop,!0),redraw())}),$("#canvas").mouseup(function(e){paint=!1,redraw()}),$("#canvas").mouseleave(function(e){paint=!1})}function addClick(e,t,o){clickX.push(e),clickY.push(t),clickTool.push(curTool),clickColor.push(curColor),clickSize.push(curSize),clickDrag.push(o)}function clearCanvas(){context.clearRect(0,0,canvasWidth,canvasHeight)}function redraw(){if(!(curLoadResNum<totalLoadResources)){var e,t,o;clearCanvas(),"crayon"==curTool?(context.drawImage(crayonBackgroundImage,0,0,canvasWidth,canvasHeight),e=curColor==colorPurple?18:52,t=19,context.beginPath(),context.moveTo(e+41,t+11),context.lineTo(e+41,t+35),context.lineTo(e+29,t+35),context.lineTo(e+29,t+33),context.lineTo(e+11,t+27),context.lineTo(e+11,t+19),context.lineTo(e+29,t+13),context.lineTo(e+29,t+11),context.lineTo(e+41,t+11),context.closePath(),context.fillStyle=colorPurple,context.fill(),curColor==colorPurple?context.drawImage(crayonImage,e,t,mediumImageWidth,mediumImageHeight):context.drawImage(crayonImage,0,0,59,mediumImageHeight,e,t,59,mediumImageHeight),e=curColor==colorGreen?18:52,t+=46,context.beginPath(),context.moveTo(e+41,t+11),context.lineTo(e+41,t+35),context.lineTo(e+29,t+35),context.lineTo(e+29,t+33),context.lineTo(e+11,t+27),context.lineTo(e+11,t+19),context.lineTo(e+29,t+13),context.lineTo(e+29,t+11),context.lineTo(e+41,t+11),context.closePath(),context.fillStyle=colorGreen,context.fill(),curColor==colorGreen?context.drawImage(crayonImage,e,t,mediumImageWidth,mediumImageHeight):context.drawImage(crayonImage,0,0,59,mediumImageHeight,e,t,59,mediumImageHeight),e=curColor==colorYellow?18:52,t+=46,context.beginPath(),context.moveTo(e+41,t+11),context.lineTo(e+41,t+35),context.lineTo(e+29,t+35),context.lineTo(e+29,t+33),context.lineTo(e+11,t+27),context.lineTo(e+11,t+19),context.lineTo(e+29,t+13),context.lineTo(e+29,t+11),context.lineTo(e+41,t+11),context.closePath(),context.fillStyle=colorYellow,context.fill(),curColor==colorYellow?context.drawImage(crayonImage,e,t,mediumImageWidth,mediumImageHeight):context.drawImage(crayonImage,0,0,59,mediumImageHeight,e,t,59,mediumImageHeight),e=curColor==colorBrown?18:52,t+=46,context.beginPath(),context.moveTo(e+41,t+11),context.lineTo(e+41,t+35),context.lineTo(e+29,t+35),context.lineTo(e+29,t+33),context.lineTo(e+11,t+27),context.lineTo(e+11,t+19),context.lineTo(e+29,t+13),context.lineTo(e+29,t+11),context.lineTo(e+41,t+11),context.closePath(),context.fillStyle=colorBrown,context.fill(),curColor==colorBrown?context.drawImage(crayonImage,e,t,mediumImageWidth,mediumImageHeight):context.drawImage(crayonImage,0,0,59,mediumImageHeight,e,t,59,mediumImageHeight)):"marker"==curTool?(context.drawImage(markerBackgroundImage,0,0,canvasWidth,canvasHeight),e=curColor==colorPurple?18:52,t=19,context.beginPath(),context.moveTo(e+10,t+24),context.lineTo(e+10,t+24),context.lineTo(e+22,t+16),context.lineTo(e+22,t+31),context.closePath(),context.fillStyle=colorPurple,context.fill(),curColor==colorPurple?context.drawImage(markerImage,e,t,mediumImageWidth,mediumImageHeight):context.drawImage(markerImage,0,0,59,mediumImageHeight,e,t,59,mediumImageHeight),e=curColor==colorGreen?18:52,t+=46,context.beginPath(),context.moveTo(e+10,t+24),context.lineTo(e+10,t+24),context.lineTo(e+22,t+16),context.lineTo(e+22,t+31),context.closePath(),context.fillStyle=colorGreen,context.fill(),curColor==colorGreen?context.drawImage(markerImage,e,t,mediumImageWidth,mediumImageHeight):context.drawImage(markerImage,0,0,59,mediumImageHeight,e,t,59,mediumImageHeight),e=curColor==colorYellow?18:52,t+=46,context.beginPath(),context.moveTo(e+10,t+24),context.lineTo(e+10,t+24),context.lineTo(e+22,t+16),context.lineTo(e+22,t+31),context.closePath(),context.fillStyle=colorYellow,context.fill(),curColor==colorYellow?context.drawImage(markerImage,e,t,mediumImageWidth,mediumImageHeight):context.drawImage(markerImage,0,0,59,mediumImageHeight,e,t,59,mediumImageHeight),e=curColor==colorBrown?18:52,t+=46,context.beginPath(),context.moveTo(e+10,t+24),context.lineTo(e+10,t+24),context.lineTo(e+22,t+16),context.lineTo(e+22,t+31),context.closePath(),context.fillStyle=colorBrown,context.fill(),curColor==colorBrown?context.drawImage(markerImage,e,t,mediumImageWidth,mediumImageHeight):context.drawImage(markerImage,0,0,59,mediumImageHeight,e,t,59,mediumImageHeight)):"eraser"==curTool?(context.drawImage(eraserBackgroundImage,0,0,canvasWidth,canvasHeight),context.drawImage(eraserImage,18,19,mediumImageWidth,mediumImageHeight)):alert("Error: Current Tool is undefined"),"small"==curSize?e=467:"normal"==curSize?e=450:"large"==curSize?e=428:"huge"==curSize&&(e=399),t=189,context.beginPath(),context.rect(e,t,2,12),context.closePath(),context.fillStyle="#333333",context.fill(),context.save(),context.beginPath(),context.rect(drawingAreaX,drawingAreaY,drawingAreaWidth,drawingAreaHeight),context.clip();for(var a=0;a<clickX.length;a++)"small"==clickSize[a]?o=2:"normal"==clickSize[a]?o=5:"large"==clickSize[a]?o=10:"huge"==clickSize[a]?o=20:(alert("Error: Radius is zero for click "+a),o=0),context.beginPath(),clickDrag[a]&&a?context.moveTo(clickX[a-1],clickY[a-1]):context.moveTo(clickX[a],clickY[a]),context.lineTo(clickX[a],clickY[a]),context.closePath(),"eraser"==clickTool[a]?context.strokeStyle="white":context.strokeStyle=clickColor[a],context.lineJoin="round",context.lineWidth=o,context.stroke();context.restore(),"crayon"==curTool&&(context.globalAlpha=.4,context.drawImage(crayonTextureImage,0,0,canvasWidth,canvasHeight)),context.globalAlpha=1,context.drawImage(outlineImage,drawingAreaX,drawingAreaY,drawingAreaWidth,drawingAreaHeight)}}